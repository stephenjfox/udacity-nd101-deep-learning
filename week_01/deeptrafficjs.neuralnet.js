
//<![CDATA[

// a few things don't have var in front of them - they update already existing variables the game needs
lanesSide = 1;
patchesAhead = 5;
patchesBehind = 2;
trainIterations = 10000;

var num_inputs = (lanesSide * 2 + 1) * (patchesAhead + patchesBehind);
var num_actions = 5;
var temporal_window = 3;
var network_size = num_inputs * temporal_window + num_actions * temporal_window + num_inputs;

var layer_defs = [];
layer_defs.push({
    type: 'input',
    out_sx: 1,
    out_sy: 1,
    out_depth: network_size
});
layer_defs.push({
    type: 'fc',
    num_neurons: 3,
    activation: 'relu'
});
layer_defs.push({
    type: 'relu',
    num_neurons: 4,
    activation: 'relu'
});
layer_defs.push({
    type: 'regression',
    num_neurons: num_actions
});

var tdtrainer_options = {
    learning_rate: 0.001,
    momentum: 0.0,
    batch_size: 64,
    l2_decay: 0.01
};

var opt = {};
opt.temporal_window = temporal_window;
opt.experience_size = 3000;
opt.start_learn_threshold = 500;
opt.gamma = 0.7;
opt.learning_steps_total = 10000;
opt.learning_steps_burnin = 1000;
opt.epsilon_min = 0.0;
opt.epsilon_test_time = 0.0;
opt.layer_defs = layer_defs;
opt.tdtrainer_options = tdtrainer_options;

brain = new deepqlearn.Brain(num_inputs, num_actions, opt);

learn = function (state, lastReward) {
    brain.backward(lastReward);
    var action = brain.forward(state);

    draw_net();
    draw_stats();

    return action;
}

//]]>
    
/*###########*/
if (brain) {
brain.value_net.fromJSON({"layers":[{"out_depth":99,"out_sx":1,"out_sy":1,"layer_type":"input"},{"out_depth":3,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":99,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":99,"w":{"0":-0.06407890397059351,"1":-0.09919754996724685,"2":0.1484874432152537,"3":0.027673613108066552,"4":-0.04124700895601427,"5":-0.08009627253213882,"6":0.008902263151363264,"7":-0.04729177699363527,"8":0.15414517888853846,"9":-0.02835935460521657,"10":0.1428279814667129,"11":0.1410655524260027,"12":-0.2145177753426989,"13":0.1262045001699836,"14":0.12446876370593049,"15":0.14832073773159882,"16":-0.04166918079205993,"17":-0.004760813741112407,"18":-0.009969488050440707,"19":-0.03375539097244453,"20":0.021053599842957765,"21":0.017097675407964183,"22":-0.14741954760112586,"23":0.09170129169963094,"24":-0.03543327394769923,"25":-0.20609058250199316,"26":-0.038287858959129346,"27":-0.024598577311057506,"28":-0.0017711975408242191,"29":-0.04700749146208148,"30":0.0104271015982585,"31":-0.2320920508552822,"32":-0.06760582355464118,"33":-0.11804907969251291,"34":-0.006571612225257759,"35":0.05454477848364451,"36":0.021207323508586867,"37":-0.1608943112297405,"38":0.0919278226871515,"39":-0.02644243216203956,"40":-0.08511714462530816,"41":0.08694105186163181,"42":-0.02366992651630899,"43":-0.08460120159156054,"44":0.051233149013674796,"45":0.03845366953305986,"46":0.041540440593854935,"47":0.007986670190872597,"48":0.19203356695451548,"49":0.004188628484710573,"50":-0.11992284130163139,"51":-0.01833925047456664,"52":-0.1077109147923396,"53":0.0468929318556114,"54":0.04704163255002666,"55":-0.06582118080873932,"56":0.005292867028456607,"57":-0.13448085843248084,"58":-0.16971558231970924,"59":0.1766493142527678,"60":0.0400973534232508,"61":0.15054472676660496,"62":0.13991034239973588,"63":-0.04488495172973798,"64":0.004192375098260714,"65":-0.1328265484090604,"66":-0.038234530033028805,"67":0.045939156841214746,"68":-0.07249749375168664,"69":-0.1646434104508835,"70":-0.18206924731433655,"71":-0.11532502493512312,"72":-0.12438832523095635,"73":-0.11036962609662339,"74":0.06279500088901495,"75":-0.13043491651503358,"76":0.019847488531720813,"77":-0.020158478214036823,"78":0.08903161359379223,"79":-0.1351408103474926,"80":-0.02179204868849354,"81":-0.07234619597559375,"82":-0.135772900255446,"83":-0.04298775773432125,"84":0.14513446721140777,"85":0.044293731707416246,"86":0.12868432406199493,"87":-0.2038797294869822,"88":-0.08383464344960648,"89":-0.20663976461062625,"90":-0.1046771068906907,"91":0.09017369251168485,"92":-0.109820708486647,"93":-0.03317887803277258,"94":-0.012788966386473864,"95":0.029487035156836976,"96":-0.21673888631891053,"97":0.038415052169007834,"98":0.025095379725837193}},{"sx":1,"sy":1,"depth":99,"w":{"0":0.008200120303208767,"1":0.13797031280056687,"2":0.03790806611120361,"3":0.004751009693205903,"4":-0.0516732562805118,"5":-0.007870941019287904,"6":-0.009148836601060039,"7":0.1007602610582194,"8":0.03354217975509766,"9":-0.07686028639173217,"10":0.08660466924739071,"11":-0.11552309332146937,"12":-0.0815603778965391,"13":0.31232658922200324,"14":0.032937035523939444,"15":0.07462541308796172,"16":-0.8077001003053409,"17":-0.0320370942415235,"18":0.048703022971768206,"19":-0.739718659103959,"20":0.0017069421585414698,"21":-0.10951461361119637,"22":0.08017732960558688,"23":0.00581154966484191,"24":-0.09646130896986681,"25":0.12172285981786553,"26":-0.2021160150778411,"27":-0.07003183370026803,"28":0.13151979653484597,"29":0.11073171989179573,"30":-0.11633344850354357,"31":0.07404611499640912,"32":-0.07079933332829567,"33":0.02660439606919731,"34":0.027037785676832207,"35":0.01889785844436945,"36":0.1413461905976981,"37":0.0006414015238001915,"38":-0.11155262580991834,"39":-0.08939175305271092,"40":-0.27985294524187765,"41":0.024392901574475944,"42":0.0797336011454427,"43":0.12466148213189929,"44":-0.02401461884696097,"45":0.08779203617902841,"46":0.07483777681994151,"47":0.09740397792222276,"48":-0.009187344651589319,"49":0.0010831997177350161,"50":-0.09973879465525962,"51":0.04064589200578471,"52":0.09789427511633039,"53":-0.039572137527132144,"54":0.10579156306744053,"55":-0.15611322858472312,"56":0.019717167076433666,"57":0.16172974451423594,"58":-0.057850888758763194,"59":0.014244149990873168,"60":-0.040869922555211866,"61":0.01302260541133179,"62":-0.01793022771590974,"63":0.0062638523840998234,"64":-0.03633441551973169,"65":0.12624060088473477,"66":0.02315940187440286,"67":-0.1320611112582592,"68":0.19926821830961974,"69":0.2646946247243502,"70":0.15140537749349411,"71":0.22498267193118265,"72":0.21641512852905348,"73":-0.08511646185701838,"74":0.19193181887330138,"75":-0.05501449424321786,"76":-0.0700615604976587,"77":-0.02364499042951617,"78":-0.0699456976701585,"79":0.07195135136929494,"80":0.1589233449498654,"81":-0.08347278976786769,"82":0.07465330053887605,"83":0.02499375597789974,"84":0.053655056311797386,"85":0.03643492453362342,"86":0.10019851027277803,"87":-0.05526783167939547,"88":-0.019300487924157096,"89":0.0812242972984672,"90":-0.14539422303575714,"91":-0.0821046181173914,"92":-0.014640315403660092,"93":0.12130408066435334,"94":0.11444306459680434,"95":0.15524840041184418,"96":0.1225840143756099,"97":0.12753991015033084,"98":0.13294308557291956}},{"sx":1,"sy":1,"depth":99,"w":{"0":0.18111889826891928,"1":0.26103928854016195,"2":-0.05041033820743864,"3":-0.11032551929829561,"4":0.06372038404471903,"5":0.21380328743375243,"6":0.029813927219876923,"7":0.11300200873193926,"8":-0.0034446439981688235,"9":0.11215705089050437,"10":-0.09306725894376829,"11":0.10453285800090717,"12":-0.04835780727787706,"13":-0.08704413753532857,"14":-0.14319833937615173,"15":0.1379360205228165,"16":0.4103878448264039,"17":0.041610598396373745,"18":0.22387178305934882,"19":0.3928502564165517,"20":0.010315999136298848,"21":0.05187476130505547,"22":-0.03223454317517012,"23":0.03207567276105785,"24":-0.03650559530409927,"25":-0.010986986593990236,"26":-0.0033558935586696214,"27":-0.036523145847719984,"28":0.07448018607024619,"29":0.0720178659896112,"30":-0.11804323847298599,"31":-0.2795578136274772,"32":0.033808526657788295,"33":0.1077069883812226,"34":-0.12720011474077778,"35":-0.0319225689055301,"36":0.26403351446682327,"37":0.0520651563045302,"38":0.1228023565007683,"39":0.10090889382678683,"40":-0.03091923849157783,"41":0.07428853488891933,"42":-0.017600581710270645,"43":0.06292415812221006,"44":-0.13515577895108138,"45":-0.008939050635551917,"46":-0.04455653924961355,"47":0.11808311331767786,"48":-0.09980891118619088,"49":-0.1330319547277658,"50":-0.024702475141826434,"51":0.06625157594682984,"52":-0.041802609885796684,"53":-0.029809402797986623,"54":0.05934350070649192,"55":0.07157495698285672,"56":-0.013116173356142154,"57":-0.020026490914977598,"58":0.053001328385759536,"59":0.16721023196385007,"60":0.07978690291284775,"61":-0.02612665336863202,"62":0.015182898023560473,"63":0.09305095877896762,"64":-0.026051660810777845,"65":-0.005538857747847588,"66":0.08128852680968153,"67":0.25408132751584406,"68":-0.006269462093302585,"69":0.08730367628712912,"70":-0.06589054973390905,"71":-0.0013796552319919652,"72":0.011531787042463394,"73":0.022246456285701446,"74":-0.017526612248826144,"75":0.06223208167367177,"76":-0.07297939509354813,"77":0.16228864842281507,"78":-0.04531976995134502,"79":-0.04261003891203106,"80":-0.06866603182000797,"81":-0.031693183757918936,"82":0.10670957652668821,"83":-0.08828386249780229,"84":-0.031441535671417574,"85":-0.14965239652923162,"86":-0.07315694214589998,"87":0.006631848581135257,"88":0.08218331942679395,"89":0.19185791083031167,"90":0.05864780158471741,"91":-0.058053366233631644,"92":0.09295360781286545,"93":-0.07696948962880533,"94":0.0024950108409782976,"95":0.0705970656805769,"96":0.01651621444878041,"97":0.03342380593910713,"98":0.033826780516318655}}],"biases":{"sx":1,"sy":1,"depth":3,"w":{"0":0.09168507367599113,"1":0.13601229793388273,"2":0.0918235996312144}}},{"out_depth":3,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":3,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":3,"out_sx":1,"out_sy":1,"layer_type":"relu"},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"fc","num_inputs":3,"l1_decay_mul":0,"l2_decay_mul":1,"filters":[{"sx":1,"sy":1,"depth":3,"w":{"0":-0.5212401122709283,"1":-0.9138102437132151,"2":0.740664575202586}},{"sx":1,"sy":1,"depth":3,"w":{"0":0.02154230589874676,"1":-0.925501133956599,"2":0.5531940290387928}},{"sx":1,"sy":1,"depth":3,"w":{"0":-1.117391325778516,"1":-0.6674225392045202,"2":0.5949866811908017}},{"sx":1,"sy":1,"depth":3,"w":{"0":-0.573519337278688,"1":-0.8391155128608041,"2":0.7250795330267203}},{"sx":1,"sy":1,"depth":3,"w":{"0":0.41759228221333616,"1":-0.8059424861910488,"2":0.7303628057996728}}],"biases":{"sx":1,"sy":1,"depth":5,"w":{"0":2.3008585911554356,"1":4.256475270660893,"2":1.5461297971603236,"3":2.3526553668617796,"4":2.353147342827906}}},{"out_depth":5,"out_sx":1,"out_sy":1,"layer_type":"regression","num_inputs":5}]});
}